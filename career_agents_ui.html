<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Career Agents â€” QA Job Switch Toolkit</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a3a;
    --accent: #7c5cfc;
    --accent2: #fc5c7d;
    --accent3: #5cfcc8;
    --text: #e8e8f0;
    --text-dim: #7878a0;
    --text-muted: #4a4a6a;
    --gap: #fc5c7d;
    --tailor: #7c5cfc;
    --outreach: #5cfcc8;
    --interview: #fcc35c;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* Sidebar */
  .sidebar {
    width: 260px;
    min-width: 260px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .logo {
    padding: 24px 20px 16px;
    border-bottom: 1px solid var(--border);
  }

  .logo-title {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    color: var(--text);
    letter-spacing: -0.5px;
  }

  .logo-sub {
    font-size: 10px;
    color: var(--text-muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 4px;
  }

  .api-section {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .api-label {
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 8px;
  }

  .api-input-wrap {
    position: relative;
  }

  .api-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    padding: 8px 10px;
    border-radius: 6px;
    outline: none;
    transition: border-color 0.2s;
  }

  .api-input:focus { border-color: var(--accent); }
  .api-input.valid { border-color: var(--accent3); }

  .api-status {
    font-size: 10px;
    margin-top: 5px;
    color: var(--text-muted);
  }
  .api-status.ok { color: var(--accent3); }
  .api-status.err { color: var(--accent2); }

  .agents-label {
    padding: 16px 20px 8px;
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  .agent-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 12px 12px;
  }

  .agent-btn {
    width: 100%;
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    text-align: left;
    transition: all 0.15s;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .agent-btn:hover {
    background: var(--surface2);
    color: var(--text);
    border-color: var(--border);
  }

  .agent-btn.active {
    background: var(--surface2);
    color: var(--text);
    border-color: var(--border);
  }

  .agent-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .agent-btn[data-agent="gap"] .agent-dot { background: var(--gap); }
  .agent-btn[data-agent="tailor"] .agent-dot { background: var(--tailor); }
  .agent-btn[data-agent="outreach"] .agent-dot { background: var(--outreach); }
  .agent-btn[data-agent="interview"] .agent-dot { background: var(--interview); }

  .agent-btn.active[data-agent="gap"] { border-color: var(--gap); box-shadow: 0 0 0 1px rgba(252,92,125,0.2); }
  .agent-btn.active[data-agent="tailor"] { border-color: var(--tailor); box-shadow: 0 0 0 1px rgba(124,92,252,0.2); }
  .agent-btn.active[data-agent="outreach"] { border-color: var(--outreach); box-shadow: 0 0 0 1px rgba(92,252,200,0.2); }
  .agent-btn.active[data-agent="interview"] { border-color: var(--interview); box-shadow: 0 0 0 1px rgba(252,195,92,0.2); }

  .agent-name { flex: 1; }
  .agent-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 3px;
    background: var(--surface);
    color: var(--text-muted);
  }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
  }

  .clear-btn {
    width: 100%;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .clear-btn:hover {
    border-color: var(--accent2);
    color: var(--accent2);
  }

  /* Main area */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Header */
  .header {
    padding: 20px 28px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface);
  }

  .header-agent {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .header-name {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 16px;
  }

  .header-desc {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .header-mode {
    display: flex;
    gap: 6px;
  }

  .mode-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .mode-btn:hover { color: var(--text); border-color: var(--text-muted); }
  .mode-btn.active { background: var(--accent); border-color: var(--accent); color: white; }

  /* Chat area */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .chat-area::-webkit-scrollbar { width: 4px; }
  .chat-area::-webkit-scrollbar-track { background: transparent; }
  .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Welcome screen */
  .welcome {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px;
    gap: 24px;
  }

  .welcome-icon {
    font-size: 48px;
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
  }

  .welcome-title {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 24px;
    color: var(--text);
  }

  .welcome-desc {
    font-size: 13px;
    color: var(--text-dim);
    max-width: 420px;
    line-height: 1.8;
  }

  .starter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    max-width: 500px;
  }

  .chip {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    padding: 8px 14px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .chip:hover {
    color: var(--text);
    border-color: var(--accent);
    background: rgba(124,92,252,0.1);
  }

  /* Messages */
  .msg {
    display: flex;
    gap: 12px;
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg.user { flex-direction: row-reverse; }

  .msg-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
  }

  .msg.user .msg-avatar {
    background: var(--accent);
    color: white;
    font-size: 11px;
  }

  .msg.agent .msg-avatar {
    background: var(--surface2);
    border: 1px solid var(--border);
  }

  .msg-content {
    max-width: 70%;
  }

  .msg.user .msg-content { align-items: flex-end; display: flex; flex-direction: column; }

  .msg-bubble {
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 13px;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .msg.user .msg-bubble {
    background: var(--accent);
    color: white;
    border-bottom-right-radius: 3px;
  }

  .msg.agent .msg-bubble {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-bottom-left-radius: 3px;
    color: var(--text);
  }

  .msg-time {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 4px;
    padding: 0 4px;
  }

  /* Typing indicator */
  .typing-bubble {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-bottom-left-radius: 3px;
    padding: 14px 18px;
    border-radius: 12px;
    display: flex;
    gap: 5px;
    align-items: center;
  }

  .typing-dot {
    width: 6px;
    height: 6px;
    background: var(--text-muted);
    border-radius: 50%;
    animation: typingBounce 1.2s ease-in-out infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
  }

  /* Code blocks in messages */
  .msg-bubble code {
    font-family: 'DM Mono', monospace;
    background: rgba(0,0,0,0.3);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
  }

  .msg-bubble pre {
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    overflow-x: auto;
    margin: 8px 0;
    font-size: 12px;
  }

  /* Input area */
  .input-area {
    padding: 16px 28px 24px;
    border-top: 1px solid var(--border);
    background: var(--surface);
  }

  .input-wrap {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 14px;
    transition: border-color 0.2s;
  }

  .input-wrap:focus-within {
    border-color: var(--accent);
  }

  .chat-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    resize: none;
    outline: none;
    max-height: 120px;
    line-height: 1.5;
  }

  .chat-input::placeholder { color: var(--text-muted); }

  .send-btn {
    background: var(--accent);
    border: none;
    color: white;
    width: 34px;
    height: 34px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
    font-size: 14px;
  }

  .send-btn:hover { background: #6a4ae8; transform: scale(1.05); }
  .send-btn:disabled { background: var(--surface); color: var(--text-muted); cursor: not-allowed; transform: none; }

  .input-hint {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 8px;
    padding: 0 2px;
  }

  /* Context panel */
  .context-panel {
    padding: 12px 28px;
    background: rgba(124,92,252,0.05);
    border-bottom: 1px solid rgba(124,92,252,0.2);
    display: none;
    gap: 12px;
    align-items: center;
    font-size: 11px;
    color: var(--text-dim);
  }

  .context-panel.visible { display: flex; }

  .context-tag {
    background: rgba(124,92,252,0.15);
    border: 1px solid rgba(124,92,252,0.3);
    color: var(--accent);
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 10px;
  }

  /* GitHub section */
  .github-section {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
  }

  .github-title {
    font-size: 10px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 10px;
  }

  .github-steps {
    font-size: 10px;
    color: var(--text-dim);
    line-height: 1.8;
  }

  .github-steps code {
    color: var(--accent3);
    font-size: 10px;
  }

  /* Error toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--accent2);
    color: white;
    font-size: 12px;
    padding: 10px 16px;
    border-radius: 8px;
    animation: slideUp 0.2s ease;
    z-index: 100;
  }

  @keyframes slideUp {
    from { transform: translateY(10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  /* Scrollbar for chat */
  .chat-area::-webkit-scrollbar { width: 3px; }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="logo">
    <div class="logo-title">Career Agents</div>
    <div class="logo-sub">QA Job Switch Toolkit</div>
  </div>

  <div class="api-section">
    <div class="api-label">Anthropic API Key</div>
    <div class="api-input-wrap">
      <input type="password" class="api-input" id="apiKey" placeholder="sk-ant-..." />
    </div>
    <div class="api-status" id="apiStatus">Enter key to start chatting</div>
  </div>

  <div class="agents-label">Agents</div>

  <div class="agent-list">
    <button class="agent-btn active" data-agent="gap" onclick="selectAgent('gap')">
      <div class="agent-dot"></div>
      <span class="agent-name">Gap Analyst</span>
      <span class="agent-badge">01</span>
    </button>
    <button class="agent-btn" data-agent="tailor" onclick="selectAgent('tailor')">
      <div class="agent-dot"></div>
      <span class="agent-name">Resume Tailor</span>
      <span class="agent-badge">02</span>
    </button>
    <button class="agent-btn" data-agent="outreach" onclick="selectAgent('outreach')">
      <div class="agent-dot"></div>
      <span class="agent-name">Outreach Drafter</span>
      <span class="agent-badge">03</span>
    </button>
    <button class="agent-btn" data-agent="interview" onclick="selectAgent('interview')">
      <div class="agent-dot"></div>
      <span class="agent-name">Interview Prep</span>
      <span class="agent-badge">04</span>
    </button>
  </div>

  <div class="github-section">
    <div class="github-title">Push to GitHub</div>
    <div class="github-steps">
      <code>cd career_agents</code><br>
      <code>git init</code><br>
      <code>gh repo create career-agents --public</code><br>
      <code>git add . && git commit -m "init"</code><br>
      <code>git push -u origin main</code>
    </div>
  </div>

  <div class="sidebar-footer">
    <button class="clear-btn" onclick="clearChat()">Clear conversation</button>
  </div>
</div>

<!-- Main -->
<div class="main">
  <div class="header">
    <div class="header-agent">
      <div class="header-dot" id="headerDot" style="background: var(--gap)"></div>
      <div>
        <div class="header-name" id="headerName">Gap Analyst</div>
        <div class="header-desc" id="headerDesc">Compare your resume vs job descriptions</div>
      </div>
    </div>
    <div class="header-mode" id="modeBar"></div>
  </div>

  <div class="context-panel" id="contextPanel">
    <span>Active context:</span>
    <span class="context-tag" id="contextTag"></span>
    <span style="flex:1"></span>
    <span style="cursor:pointer;color:var(--text-muted)" onclick="clearContext()">âœ• clear</span>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="welcome" id="welcomeScreen">
      <div class="welcome-icon">ðŸŽ¯</div>
      <div class="welcome-title">Gap Analyst</div>
      <div class="welcome-desc">Paste your resume + job descriptions and I'll identify skill gaps, missing keywords, and your top priorities for the Gurugram job market.</div>
      <div class="starter-chips" id="starterChips"></div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrap">
      <textarea class="chat-input" id="chatInput" placeholder="Type your message..." rows="1"
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
    </div>
    <div class="input-hint">Enter to send Â· Shift+Enter for new line</div>
  </div>
</div>

<script>
// â”€â”€ Agent definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AGENTS = {
  gap: {
    name: "Gap Analyst",
    desc: "Compare your resume vs job descriptions",
    color: "var(--gap)",
    icon: "ðŸ”",
    system: `You are a deeply technical QA recruiter with 15+ years of hiring experience in India's top product companies and GCCs in Gurugram. You specialize in QA Manager, Test Lead, SDET, and QA Director roles.

You understand Naukri.com and LinkedIn India ATS systems. You know companies like Publicis Sapient, EXL, Genpact, MakeMyTrip, Info Edge, PolicyBazaar, Flipkart, Paytm.

When a user shares their resume or JD:
1. Identify skill gaps with urgency levels (critical / important / nice-to-have)
2. List ATS keywords missing from the resume
3. Give India-market-specific advice
4. Suggest top 3 immediate priorities

Format your analysis with clear sections. Be direct and specific â€” no vague advice.`,
    starters: [
      "Here's my resume. What are my gaps for a QA Director role?",
      "Analyze this JD and tell me what keywords I must add",
      "I'm a Test Manager targeting Gurugram GCCs. What's missing?",
      "Compare my resume to this JD and give me an ATS score"
    ],
    modes: ["Resume Analysis", "JD Keywords", "Market Fit"]
  },
  tailor: {
    name: "Resume Tailor",
    desc: "ATS-optimize your resume for specific JDs",
    color: "var(--tailor)",
    icon: "âœï¸",
    system: `You are an expert resume writer for senior QA/Test professionals in India. You specialize in tailoring resumes for Naukri and LinkedIn ATS systems.

Rules you follow:
- NEVER fabricate experience â€” only rephrase and reframe real experience  
- Inject ATS keywords naturally into existing bullet points
- Lead bullets with strong action verbs that match the JD
- Add implied metrics where reasonable
- Write in confident, executive tone for Director/Principal level roles
- Flag genuine gaps honestly

When given a resume + JD:
1. Identify all ATS keywords from the JD
2. Rewrite key bullet points to include missing keywords naturally
3. Give an estimated ATS match score (0-100)
4. Rewrite the professional summary targeting this specific JD
5. Flag any requirements with no resume match`,
    starters: [
      "Rewrite my resume summary for this QA Director JD",
      "Which bullets should I rewrite to hit 80%+ ATS score?",
      "I have 8 years experience but my resume reads like 3. Fix it.",
      "How do I describe my Selenium work to sound more senior?"
    ],
    modes: ["Full Tailoring", "Bullet Rewrite", "Summary Only"]
  },
  outreach: {
    name: "Outreach Drafter",
    desc: "Personalized LinkedIn messages that get replies",
    color: "var(--outreach)",
    icon: "ðŸ¤",
    system: `You are an expert at professional networking in India's tech industry. You write LinkedIn outreach that gets responses.

Your rules:
- NEVER use: "I'd love to connect", "I came across your profile", "Reaching out to expand my network"
- Always reference ONE specific thing from their profile (post, achievement, company, tech stack)
- Keep connection requests under 300 characters (LinkedIn limit)
- Write India-culturally appropriate messages â€” formal but not stiff
- Focus on value exchange, not just asking

Angle options:
- just_connect: building professional network
- job_interest: interested in opportunities at their company
- referral_ask: hoping for a referral to a role
- insight_ask: asking for career advice

When given a LinkedIn profile, generate 3 variants:
- Variant A: Hook from their recent post/achievement
- Variant B: Hook from shared tech/industry challenge  
- Variant C: Hook from a genuine question or insight

For each: write the connection request + follow-up message (for after acceptance)`,
    starters: [
      "Write outreach for a QA Director at Publicis Sapient",
      "Draft a message to ask for referral at PolicyBazaar",
      "I want to connect with the Head of Engineering at MakeMyTrip",
      "Help me write to someone who posted about test automation"
    ],
    modes: ["Just Connect", "Job Interest", "Ask for Referral"]
  },
  interview: {
    name: "Interview Prep",
    desc: "Mock interviews, system design & code review",
    color: "var(--interview)",
    icon: "ðŸŽ™ï¸",
    system: `You are a tough but fair technical interviewer at a top product company in India. You interview candidates for QA Director, Principal SDET, and Test Manager roles.

Modes you operate in:

MOCK INTERVIEW MODE: Ask questions one at a time. After each answer, give honest feedback (what was good, what was missing), then ask the follow-up. After 6-8 questions, give a final Hire/No-Hire verdict with specific reasons.

CODE REVIEW MODE: When given automation code, roast it honestly. Tell them what's wrong (with line references), how a Staff Engineer would refactor it, which design patterns to use, and what interviewers would ask about it.

BEHAVIORAL MODE: Generate top behavioral questions for senior QA roles in India. Include STAR framework guidance, India-specific context (offshore teams, US stakeholder management), and red flags that get candidates rejected.

SYSTEM DESIGN MODE: Present a test architecture challenge. Guide through expected solution covering: test strategy, CI/CD integration, observability, edge cases, and team structure.

Always be specific. No generic advice.`,
    starters: [
      "Start a mock interview for QA Director at Paytm",
      "Review my Selenium Page Object code and roast it",
      "Give me top 10 behavioral questions for QA Manager",
      "Design a test strategy for a payment gateway with 10M daily transactions"
    ],
    modes: ["Mock Interview", "Code Review", "Behavioral", "System Design"]
  }
};

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentAgent = 'gap';
let conversations = { gap: [], tailor: [], outreach: [], interview: [] };
let isLoading = false;
let activeMode = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('apiKey').addEventListener('input', (e) => {
  const val = e.target.value.trim();
  const status = document.getElementById('apiStatus');
  if (val.startsWith('sk-ant-') && val.length > 20) {
    e.target.classList.add('valid');
    status.textContent = 'âœ“ Key looks valid';
    status.className = 'api-status ok';
  } else if (val.length > 0) {
    e.target.classList.remove('valid');
    status.textContent = 'Key should start with sk-ant-';
    status.className = 'api-status err';
  } else {
    e.target.classList.remove('valid');
    status.textContent = 'Enter key to start chatting';
    status.className = 'api-status';
  }
});

function selectAgent(agentId) {
  currentAgent = agentId;
  const agent = AGENTS[agentId];

  // Update sidebar
  document.querySelectorAll('.agent-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`[data-agent="${agentId}"]`).classList.add('active');

  // Update header
  document.getElementById('headerDot').style.background = agent.color;
  document.getElementById('headerName').textContent = agent.name;
  document.getElementById('headerDesc').textContent = agent.desc;

  // Update mode bar
  const modeBar = document.getElementById('modeBar');
  modeBar.innerHTML = '';
  agent.modes.forEach((mode, i) => {
    const btn = document.createElement('button');
    btn.className = 'mode-btn' + (i === 0 ? ' active' : '');
    btn.textContent = mode;
    btn.onclick = () => {
      modeBar.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeMode = mode;
      updateContext(mode);
    };
    modeBar.appendChild(btn);
  });
  activeMode = agent.modes[0];

  // Render conversation
  renderConversation();
}

function renderConversation() {
  const agent = AGENTS[currentAgent];
  const msgs = conversations[currentAgent];
  const chatArea = document.getElementById('chatArea');

  if (msgs.length === 0) {
    chatArea.innerHTML = `
      <div class="welcome" id="welcomeScreen">
        <div class="welcome-icon">${agent.icon}</div>
        <div class="welcome-title">${agent.name}</div>
        <div class="welcome-desc">${AGENTS[currentAgent].desc}. Enter your API key and start chatting.</div>
        <div class="starter-chips">
          ${agent.starters.map(s => `<div class="chip" onclick="useStarter('${s.replace(/'/g, "\\'")}')">${s}</div>`).join('')}
        </div>
      </div>`;
  } else {
    chatArea.innerHTML = msgs.map(m => renderMsg(m)).join('');
    scrollToBottom();
  }
}

function renderMsg({ role, content, time }) {
  const agent = AGENTS[currentAgent];
  const avatar = role === 'user' ? 'ME' : agent.icon;
  const timeStr = time || '';
  return `
    <div class="msg ${role}">
      <div class="msg-avatar">${avatar}</div>
      <div class="msg-content">
        <div class="msg-bubble">${formatContent(content)}</div>
        <div class="msg-time">${timeStr}</div>
      </div>
    </div>`;
}

function formatContent(text) {
  // Basic markdown-like formatting
  return text
    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
}

function useStarter(text) {
  document.getElementById('chatInput').value = text;
  autoResize(document.getElementById('chatInput'));
  sendMessage();
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const apiKey = document.getElementById('apiKey').value.trim();
  const text = input.value.trim();

  if (!text) return;
  if (!apiKey) { showToast('Enter your Anthropic API key first'); return; }
  if (isLoading) return;

  // Add user message
  const time = new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
  conversations[currentAgent].push({ role: 'user', content: text, time });
  input.value = '';
  autoResize(input);

  // Remove welcome screen
  const welcome = document.getElementById('welcomeScreen');
  if (welcome) welcome.remove();

  // Render user message
  const chatArea = document.getElementById('chatArea');
  chatArea.insertAdjacentHTML('beforeend', renderMsg({ role: 'user', content: text, time }));

  // Add typing indicator
  const typingId = 'typing-' + Date.now();
  chatArea.insertAdjacentHTML('beforeend', `
    <div class="msg agent" id="${typingId}">
      <div class="msg-avatar">${AGENTS[currentAgent].icon}</div>
      <div class="msg-content">
        <div class="typing-bubble">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>`);
  scrollToBottom();

  isLoading = true;
  document.getElementById('sendBtn').disabled = true;

  try {
    // Build messages for API
    const apiMessages = conversations[currentAgent]
      .filter(m => m.role !== 'system')
      .slice(0, -1) // exclude last (we'll add it)
      .map(m => ({ role: m.role === 'user' ? 'user' : 'assistant', content: m.content }));

    // Add current message with mode context
    let userContent = text;
    if (activeMode) userContent = `[Mode: ${activeMode}]\n${text}`;
    apiMessages.push({ role: 'user', content: userContent });

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 2000,
        system: AGENTS[currentAgent].system,
        messages: apiMessages
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || `HTTP ${response.status}`);
    }

    const data = await response.json();
    const reply = data.content[0].text;

    // Remove typing indicator
    document.getElementById(typingId)?.remove();

    // Add assistant message
    const replyTime = new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    conversations[currentAgent].push({ role: 'assistant', content: reply, time: replyTime });
    chatArea.insertAdjacentHTML('beforeend', renderMsg({ role: 'assistant', content: reply, time: replyTime }));
    scrollToBottom();

  } catch (err) {
    document.getElementById(typingId)?.remove();
    showToast(`Error: ${err.message}`);
  }

  isLoading = false;
  document.getElementById('sendBtn').disabled = false;
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function scrollToBottom() {
  const chatArea = document.getElementById('chatArea');
  chatArea.scrollTop = chatArea.scrollHeight;
}

function clearChat() {
  conversations[currentAgent] = [];
  renderConversation();
}

function updateContext(mode) {
  const panel = document.getElementById('contextPanel');
  const tag = document.getElementById('contextTag');
  if (mode) {
    tag.textContent = mode;
    panel.classList.add('visible');
  } else {
    panel.classList.remove('visible');
  }
}

function clearContext() {
  document.getElementById('contextPanel').classList.remove('visible');
}

function showToast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// Init
selectAgent('gap');
</script>
</body>
</html>
